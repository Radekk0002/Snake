"use strict";var appleImg=new Image,rottenAppleImg=new Image,goodAppleImg=new Image,betterAppleImg=new Image,godAppleImg=new Image,trophyCup=new Image;function Apple(e,t,a,i,n,o){var s=this;s.x=20,s.y=16,s.appleEaten=!1,s.points=i,s.speed=n,s.appleSpeed=0,s.applePoints=0,s.ctx=e,s.appleSize=t,s.snakeSize=a,s.img=o}function Snake(r,i,l){var p=this;p.speed=250,p.bodyParts=5,p.bodyPartsHolder=[],p.direction="up",p.gameOver=!1,p.initSnake=function(){for(var e=0;e<p.bodyParts;e++)p.bodyPartsHolder.push({x:r.width/2,y:r.height/2+l*e});p.snakeListen()},p.drawSnake=function(){for(var e=0;e<p.bodyParts;e++){i.fillStyle="#7AE582";var t=p.bodyPartsHolder[e].x,a=p.bodyPartsHolder[e].y;"up"===p.direction||p.direction,i.fillRect(t+(l-(l-2-e/2))/2,a+(l-(l-2-e/2))/2,l-2-e/2,l-2-e/2)}i.fillStyle="black",i.beginPath(),i.arc(p.bodyPartsHolder[0].x+l/2-5,p.bodyPartsHolder[0].y+l/2-4,3,0,2*Math.PI,!1),i.fill(),i.fillStyle="black",i.beginPath(),i.arc(p.bodyPartsHolder[0].x+l-8,p.bodyPartsHolder[0].y+l/2-4,4,0,2*Math.PI,!1),i.fill()},p.snakeListen=function(){window.onkeydown=function(e){switch(e.keyCode){case 40:"up"!==p.direction&&(p.direction="down");break;case 38:"down"!==p.direction&&(p.direction="up");break;case 37:"right"!==p.direction&&(p.direction="left");break;case 39:"left"!==p.direction&&(p.direction="right")}}},p.updatePosition=function(){var e=p.bodyPartsHolder[0].x,t=p.bodyPartsHolder[0].y;switch(p.direction){case"up":p.bodyPartsHolder[0].y-=l;break;case"down":p.bodyPartsHolder[0].y+=l;break;case"right":p.bodyPartsHolder[0].x+=l;break;case"left":p.bodyPartsHolder[0].x-=l}for(var a=1;a<p.bodyParts;a++){var i=p.bodyPartsHolder[a].x,n=p.bodyPartsHolder[a].y;p.bodyPartsHolder[a].x=e,p.bodyPartsHolder[a].y=t,e=i,t=n}},p.moveSnake=function(){p.updatePosition(),p.drawSnake()},p.checkCollision=function(e,t){var a=p.bodyPartsHolder[0].x,i=p.bodyPartsHolder[0].y;if(a/l<e/(2*l)||i/l<t/(2*l)||(a+1)/l>(r.width-e/2)/l||(i+1)/l>(r.height-t/2)/l)p.gameOver=!0;else for(var n=1;n<p.bodyParts;n++){var o=p.bodyPartsHolder[n].x,s=p.bodyPartsHolder[n].y;if(a===o&&i===s){p.gameOver=!0;break}}},p.grow=function(){p.bodyParts++,p.bodyPartsHolder.push({x:p.bodyPartsHolder[p.bodyParts-1],y:p.bodyPartsHolder[p.bodyParts-1]})}}function Game(){var t=this;t.canvas=document.getElementById("game"),t.canvasWidth=t.canvas.width,t.canvasHeight=t.canvas.height,t.fieldWidth=t.canvasWidth-100,t.fieldHeight=t.canvasHeight-100,t.status="info",t.totalPoints=0,t.contWidthGameOver=300,t.contHeightGameOver=250,t.delayAppleAppear=2e3,t.appleSize=17,t.snakeSize=25,t.fields=[],t.randomAppleInterv,t.moveSnakeInterv,t.endGame=!1,t.canvas.getContext&&(t.ctx=t.canvas.getContext("2d"),t.startGameListen=function(e){13===e.keyCode&&(t.status="startGame",t.checkStatus()),window.removeEventListener("keypress",t.startGameListen)})}appleImg.src="../media/apple.png",rottenAppleImg.src="../media/rotten_apple.png",goodAppleImg.src="../media/apple_green.png",betterAppleImg.src="../media/apple_yellow.png",godAppleImg.src="../media/apple_pink.png",trophyCup.src="../media/trophy_cup.png",Apple.prototype.apples=[],Apple.prototype.randomize=function(e){var t=this;if(0<e.length){var a=Math.floor(Math.random()*e.length),i=e[a];e.splice(a,1),t.x=i.x,t.y=i.y;var n={x:t.x,y:t.y,img:t.img,points:t.points,speed:t.speed};t.apples.push(n)}},Apple.prototype.drawApples=function(){for(var e=this,t=0;t<e.apples.length;t++){var a=e.apples[t].x,i=e.apples[t].y,n=e.apples[t].img;e.ctx.drawImage(n,e.snakeSize*a,e.snakeSize*i,e.appleSize+8,e.appleSize+8)}},Apple.prototype.checkEatenApple=function(e){var t=this;t.appleEaten=!1,t.applePoints=0;for(var a=t.appleSpeed=0;a<t.apples.length;a++)if(e.x/t.snakeSize===t.apples[a].x&&e.y/t.snakeSize===t.apples[a].y){t.applePoints=t.apples[a].points,t.appleSpeed=t.apples[a].speed,t.apples.splice(a,1),t.appleEaten=!0;break}},Game.prototype.setFields=function(i){var n=this;n.fields=[];for(var e=n.fieldWidth/n.snakeSize,o=n.fieldHeight/n.snakeSize,t=(n.canvasWidth-n.fieldWidth)/2/n.snakeSize,s=(n.canvasHeight-n.fieldHeight)/2/n.snakeSize,a=function(a){for(var e=function(t){if(!i.some(function(e){return e.x===a*n.snakeSize&&e.y===t*n.snakeSize})){var e={x:a,y:t};n.fields.push(e)}},t=s;t<o+s;t++)e(t)},r=t;r<e+t;r++)a(r)},Game.prototype.drawBackground=function(){var e=this;e.ctx.beginPath(),e.ctx.strokeStyle="#9FFFCB";var t=50;e.ctx.lineWidth=t,e.ctx.moveTo(0,t/2),e.ctx.lineTo(e.canvasWidth,t/2),e.ctx.moveTo(0,e.canvasHeight-t/2),e.ctx.lineTo(e.canvasWidth,e.canvasHeight-t/2),e.ctx.stroke(),e.ctx.closePath(),e.ctx.beginPath(),t=(e.canvasWidth-e.fieldWidth)/2,e.ctx.lineWidth=t,e.ctx.moveTo(e.canvasWidth-t/2,0),e.ctx.lineTo(e.canvasWidth-t/2,e.canvasHeight),e.ctx.moveTo(t/2,0),e.ctx.lineTo(t/2,e.canvasHeight),e.ctx.stroke(),e.ctx.closePath(),e.ctx.strokeStyle="#004E64",e.ctx.lineWidth=6,e.ctx.strokeRect((e.canvasWidth-e.fieldWidth)/2-e.ctx.lineWidth/2,(e.canvasHeight-e.fieldHeight)/2-e.ctx.lineWidth/2,e.fieldWidth+e.ctx.lineWidth,e.fieldHeight+e.ctx.lineWidth),e.ctx.fillStyle="#00A5CF",e.ctx.font="30px Roboto",e.ctx.fillText("Points: ".concat(e.totalPoints),100,30),trophyCup.onload=function(){e.ctx.drawImage(trophyCup,250,-4,50,50),e.ctx.drawImage(trophyCup,380,-4,50,50)},e.ctx.drawImage(trophyCup,250,-4,50,50),e.ctx.fillText("".concat(e.bestScore),305,30),e.ctx.drawImage(trophyCup,380,-4,50,50),e.ctx.fillText("".concat(e.bestTime,"s"),435,30)},Game.prototype.getHighestScore=function(){window.localStorage.getItem("scores")?(this.bestScore=JSON.parse(window.localStorage.getItem("scores")).points,this.bestTime=JSON.parse(window.localStorage.getItem("scores")).time):(this.bestScore=0,this.bestTime=0)},Game.prototype.setHighestScore=function(){if(window.localStorage){var e=window.localStorage.getItem("scores")?JSON.parse(window.localStorage.getItem("scores")).points:0,t=window.localStorage.getItem("scores")?JSON.parse(window.localStorage.getItem("scores")).time:0,a={points:e<this.totalPoints?this.totalPoints:e,time:t<this.timeSpent?this.timeSpent:t};window.localStorage.setItem("scores",JSON.stringify(a))}},Game.prototype.drawField=function(){var e=this;e.ctx.fillStyle="#41B864",e.ctx.fillRect((e.canvasWidth-e.fieldWidth)/2,(e.canvasHeight-e.fieldHeight)/2,e.fieldWidth,e.fieldHeight)},Game.prototype.draw=function(){var t=this;!function e(){t.drawField(),t.snake.drawSnake(),t.apple.drawApples(),t.drawBackground(),t.drawID=requestAnimationFrame(e)}()},Game.prototype.shrinkCanv=function(){var t=this,a=t.fieldWidth;!function e(){t.fieldWidth===a-200&&t.contWidthGameOver+50<=a-200?t.fieldWidth=a-200:"startGame"===t.status&&t.contWidthGameOver+50<=t.fieldWidth-10&&(t.fieldWidth-=10,cancelAnimationFrame(t.drawID),t.draw(),requestAnimationFrame(e))}()},Game.prototype.startGame=function(){var t=this;t.canvas.width=t.canvasWidth,t.canvas.height=t.canvasHeight,t.getHighestScore(),t.fieldWidth=t.canvasWidth-100,t.fieldHeight=t.canvasHeight-100,t.totalPoints=0,Apple.prototype.apples=[],clearTimeout(t.moveTimeout),clearInterval(t.randomAppleInterv),t.timeStart=new Date,t.timeStartSec=t.timeStart.getTime()/1e3,t.drawField(),t.snake=new Snake(t.canvas,t.ctx,t.snakeSize),t.snake.initSnake(),t.setFields(t.snake.bodyPartsHolder),t.drawBackground(),t.apple=new Apple(t.ctx,t.appleSize,t.snakeSize,50,10,appleImg),t.goodApple=new Apple(t.ctx,t.appleSize,t.snakeSize,25,-10,goodAppleImg),t.rottenApple=new Apple(t.ctx,t.appleSize,t.snakeSize,-200,-50,rottenAppleImg),t.betterApple=new Apple(t.ctx,t.appleSize,t.snakeSize,70,5,betterAppleImg),t.godApple=new Apple(t.ctx,t.appleSize,t.snakeSize,175,-30,godAppleImg),t.apple.randomize(t.fields),t.randomAppleInterv=setInterval(function(){if(Apple.prototype.apples.length<5){t.setFields(t.snake.bodyPartsHolder);var e=0;150<=t.totalPoints&&(e=100*Math.random()),t.totalPoints<=150||e<60?t.apple.randomize(t.fields):150<=t.totalPoints&&e<75?t.rottenApple.randomize(t.fields):200<=t.totalPoints&&e<85?t.goodApple.randomize(t.fields):375<=t.totalPoints&&e<95?t.betterApple.randomize(t.fields):575<=t.totalPoints&&e<100?t.godApple.randomize(t.fields):t.apple.randomize(t.fields),cancelAnimationFrame(t.drawID)}else 5===t.apple.apples.length&&t.fieldWidth>=t.contWidthGameOver+50&&(Apple.prototype.apples=[],t.snake.speed=15<t.snake.speed-75?t.snake.speed-75:15,t.totalPoints=0<t.totalPoints-100?t.totalPoints-100:0,t.draw(),t.shrinkCanv())},t.delayAppleAppear),t.moveSnakeInterv=function(){t.snake.gameOver?(t.status="gameOver",t.checkStatus()):(t.drawField(),t.apple.drawApples(),t.snake.moveSnake(),t.snake.checkCollision(t.canvasWidth-t.fieldWidth,t.canvasHeight-t.fieldHeight),t.apple.checkEatenApple(t.snake.bodyPartsHolder[0]),t.apple.appleEaten&&(t.snake.grow(),t.totalPoints=0<=t.totalPoints+t.apple.applePoints?t.totalPoints+t.apple.applePoints:0,70<=t.snake.speed&&(t.snake.speed=70<t.snake.speed-t.apple.appleSpeed?t.snake.speed-t.apple.appleSpeed:70)),t.moveTimeout=setTimeout(function(){requestAnimationFrame(t.moveSnakeInterv)},t.snake.speed),t.drawBackground())},t.moveSnakeInterv()},Game.prototype.sendScore=function(){},Game.prototype.gameOver=function(){var e=this;e.timeEnd=new Date,e.timeEndSec=e.timeEnd.getTime()/1e3,e.timeSpent=Math.round(100*(e.timeEndSec-e.timeStartSec))/100;var t=e.contWidthGameOver/2.5,a=e.contWidthGameOver/8;clearInterval(e.randomAppleInterv),cancelAnimationFrame(e.drawID),e.drawField(),e.apple.drawApples(),e.snake.drawSnake(),e.setHighestScore(),e.getHighestScore(),e.drawBackground(),e.ctx.fillStyle="#DAD2D8",e.ctx.fillRect(e.canvas.width/2-e.contWidthGameOver/2,e.canvas.height/2-e.contHeightGameOver/2,e.contWidthGameOver,e.contHeightGameOver),e.ctx.strokeStyle="#0F8B8D",e.ctx.lineWidth=3,e.ctx.strokeRect(e.canvas.width/2-e.contWidthGameOver/2,e.canvas.height/2-e.contHeightGameOver/2,e.contWidthGameOver,e.contHeightGameOver),e.ctx.font="40px Roboto",e.ctx.fillStyle="black",e.ctx.fillText("Game Over!",e.canvas.width/2-80,e.canvas.height/2-e.contHeightGameOver/2+40,165),e.ctx.font="25px Roboto",e.ctx.fillText("Your points: ".concat(e.totalPoints),e.canvas.width/2-t,e.canvas.height/2-a),e.ctx.fillText("Your time: ".concat(e.timeSpent,"s"),e.canvas.width/2-t,e.canvas.height/2-a+28),e.ctx.lineWidth=3,e.ctx.strokeRect(e.canvas.width/2-e.contWidthGameOver/2,e.canvas.height/2+e.contHeightGameOver/4,e.contWidthGameOver,e.contHeightGameOver/4),e.ctx.font="30px Roboto",e.ctx.fillText("Restart Game ( Enter )",e.canvas.width/2-125,e.canvas.height/2+e.contHeightGameOver/2-e.contHeightGameOver/8+7.5,250),window.addEventListener("keypress",e.startGameListen)},Game.prototype.info=function(){var e=this;e.getHighestScore(),e.drawField(),e.drawBackground(),e.ctx.fillStyle="#DAD2D8",e.ctx.fillRect(e.canvas.width/2-200,e.canvas.height/2-150,400,300),e.ctx.strokeStyle="#0F8B8D",e.ctx.lineWidth=3,e.ctx.strokeRect(e.canvas.width/2-200,e.canvas.height/2-150,400,300),e.ctx.font="40px Roboto",e.ctx.fillStyle="black",e.ctx.fillText("Snake!!!",e.canvas.width/2-65,e.canvas.height/2-110,130),e.ctx.font="25px Roboto",e.ctx.fillText("Control:",e.canvas.width/2-175,e.canvas.height/2-70),e.ctx.fillText("Instructions:",e.canvas.width/2-175,e.canvas.height/2-70+46),e.ctx.font="18px Roboto",e.ctx.fillText("- Arrows on keyboard",e.canvas.width/2-150,e.canvas.height/2-70+23),e.ctx.fillText("- For every apple you will get points",e.canvas.width/2-150,e.canvas.height/2-70+69),e.ctx.fillText("- Apple will appear in every ".concat(e.delayAppleAppear/1e3,"s"),e.canvas.width/2-150,e.canvas.height/2-70+92),e.ctx.fillText("- After you will reach certain amount of points,",e.canvas.width/2-150,e.canvas.height/2-70+115),e.ctx.fillText("      the new kinds of apple will appear",e.canvas.width/2-150,e.canvas.height/2-70+138),e.ctx.lineWidth=3,e.ctx.strokeRect(e.canvas.width/2-200,e.canvas.height/2+80,400,70),e.ctx.font="30px Roboto",e.ctx.fillText("Start Game ( Enter )",e.canvas.width/2-115,e.canvas.height/2+122.5,230),window.addEventListener("keypress",e.startGameListen)},Game.prototype.checkStatus=function(){var e=this;"startGame"===e.status?e.startGame():"gameOver"===e.status?e.gameOver():"info"===e.status&&e.info()};var game=new Game;game.checkStatus();